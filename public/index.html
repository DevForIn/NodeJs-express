<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging.js"></script>
    <title>로그인 및 알림 보내기</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f4f4f4;
        }
        form {
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        input {
            margin: 10px 0;
            padding: 10px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            padding: 10px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>

    <form id="loginForm">
        <h2>로그인</h2>
        <input type="text" id="username" placeholder="사용자 이름" required>
        <input type="password" id="password" placeholder="비밀번호" required>
        <input type="text" id="fcmToken" placeholder="FCM 토큰" readonly>
        <button type="submit">로그인</button>
        <p id="message"></p>
    </form>

    <button id="sendNotification" style="display: none;">알람 보내기</button>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCcCMBVRwOxd2VGMwIzFixDG7UIT0nrtjc",
            authDomain: "node-firebase-web-57f76.firebaseapp.com",
            projectId: "node-firebase-web-57f76",
            storageBucket: "node-firebase-web-57f76.appspot.com",
            messagingSenderId: "1030944938721",
            appId: "1:1030944938721:web:2422e632649747ebaab5a0"
            };
            firebase.initializeApp(firebaseConfig);

        // Firebase Messaging 객체 생성
        const messaging = firebase.messaging();

        // 알림 권한 요청
        messaging.requestPermission()
        .then(() => {
            console.log("Notification permission granted.");
            return messaging.getToken();
        })
        .then((token) => {
            console.log("FCM Token:", token);
            document.getElementById('fcmToken').value = token; // FCM 토큰 필드에 설정
        })
        .catch((err) => {
            console.error("Unable to get permission to notify.", err);
        });

        // 알림 수신 처리
        messaging.onMessage((payload) => {
                console.log("Message received. ", payload);
                const notificationTitle = payload.notification.title;
                const notificationOptions = {
                    body: payload.notification.body,
                };

                new Notification(notificationTitle, notificationOptions);
        });

        let token; // JWT 토큰 저장 변수

        document.getElementById('loginForm').addEventListener('submit', function(event) {
            event.preventDefault(); // 기본 제출 동작 방지

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // 서버에 POST 요청
            fetch('http://localhost:3000/api/v1/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password, fcm_token: token }), // FCM 토큰 추가
                mode: 'cors' // CORS 모드 설정
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('message').innerText = data.message || data.error;

                // 로그인 성공 시 FCM 토큰 필드에 JWT 토큰 저장
                if (data.token) {
                    token = data.token; // JWT 토큰 저장
                    document.getElementById('fcmToken').value = token; // FCM 토큰 필드에 설정
                    document.getElementById('sendNotification').style.display = 'inline'; // 알림 보내기 버튼 표시
                }
            })
            .catch(error => {
                document.getElementById('message').innerText = '로그인 실패: ' + error;
            });
        });

        // 알림 보내기 버튼 클릭 이벤트
        document.getElementById('sendNotification').addEventListener('click', function() {
            const message = {
                title: '테스트 알림',
                body: '로그인 후 알림 보내기 테스트입니다.'
            };

            fetch('http://localhost:3000/api/v3/send-notification', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username: document.getElementById('username').value, message })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('message').innerText = data.message || data.error;
            })
            .catch(error => {
                document.getElementById('message').innerText = '알림 보내기 실패: ' + error;
            });
        });
    </script>

</body>
</html>
